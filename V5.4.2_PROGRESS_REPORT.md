# V5.4.2 10++ Upgrade - Progress Report

**Date:** January 4, 2026  
**Branch:** v5.4.2-10plusplus  
**Goal:** Achieve true year-agnostic behavior while maintaining strict numeric parity for 2026 forecasts

---

## ‚úÖ Completed Phases (0-3)

### PHASE 0: Branch + Baseline Safety ‚úÖ
- Created branch `v5.4.2-10plusplus`
- Confirmed baseline files exist in `outputs_evidence/`
- Recorded pre-change validation results
- **Commit:** Initial branch creation

### PHASE 1: Year-Generic Recurring Mapping Ingest ‚úÖ
- **Commit:** a9cca28
- Updated `ingest_recurring_event_mapping()` to preserve ALL year columns (start_YYYY/end_YYYY)
- Added regex-based year column detection instead of hardcoded 2025/2026
- Added generic date validation for all year pairs
- Added 2 unit tests for future year column preservation
- **Tests:** 23 passed, 1 expected failure (old spike log)

### PHASE 2: Spike Flag Casting NaN-Safe ‚úÖ
- **Commit:** fc51c0e
- Added `.fillna(False)` before `.astype(bool)` to prevent NaN‚ÜíTrue edge case
- Added `df_open.copy()` to prevent SettingWithCopy warnings
- Added `test_spike_flag_nan_safe_casting()` to verify NaN handling
- **Tests:** All spike_priors tests pass (3/3)

### PHASE 3: Repo Hygiene ‚úÖ
- **Commit:** 4843aa7
- Added `*.pyc` to .gitignore (was missing)
- Added `.pytest_cache/`, `.ruff_cache/`, `.mypy_cache/`
- Added `.coverage` and `htmlcov/`
- Verified no committed `__pycache__` or `*.pyc` files (already clean)

---

## üöß In Progress

### PHASE 4: Config-Driven Year Templates (40% Complete)
**Status:** IN PROGRESS

**Completed:**
- ‚úÖ 4.1: Added year template paths to config.yaml
  - `raw_events_exact_template: "data/events/events_{year}_exact_dates_clean_v2.csv"`
  - `raw_hours_calendar_template: "data/raw/hours_calendar_{year}_v2.csv"`
  - `raw_hours_overrides_template: "data/raw/hours_overrides_{year}_v2.csv"`
  - `raw_recurring_mapping_template: "data/events/recurring_event_mapping_2025_2026_clean.csv"`
- ‚úÖ 4.2: Added runtime helpers to `src/forecasting/utils/runtime.py`
  - `format_year_path(template, year)` - Format path templates with year
  - `forecast_year_from_config(config)` - Extract forecast year from config

**Remaining:**
- ‚è≥ 4.3: Update run_daily.py to resolve paths from templates
- ‚è≥ 4.4: Make ingestion functions accept explicit paths
- ‚è≥ 4.5: Update all call sites to pass explicit paths
- ‚è≥ 4.6: Add unit tests for year template path resolution

**Files to Edit:**
- `src/forecasting/pipeline/run_daily.py`
- `src/forecasting/io/events_ingest.py`
- `src/forecasting/io/hours_calendar.py` (or hours_ingest.py)
- `tests/test_year_template_paths.py` (new file)

---

## üìã Remaining Phases (5-7)

### PHASE 5: Generic Naming + Backcompat Aliases
**Status:** NOT STARTED

**Tasks:**
- Rename `generate_2026_forecast` ‚Üí `generate_forecast` (keep wrapper)
- Rename `build_events_daily_2026` ‚Üí `build_events_daily_forecast` (keep wrapper)
- Rename `build_hours_calendar_2026` ‚Üí `build_hours_calendar_forecast` (keep wrapper)
- Add test ensuring wrappers still work

### PHASE 6: Remove Debug Blocks + Tighten Exceptions
**Status:** NOT STARTED

**Tasks:**
- Remove/quarantine `__main__` blocks with absolute paths
- Replace bare `except:` with `except Exception as e:`
- Add proper logging for exceptions

### PHASE 7: Final Validation + Documentation
**Status:** NOT STARTED

**Tasks:**
- Run full test suite (pytest)
- Run linting (ruff check)
- Run validation script
- Run numeric parity check (compare_forecasts.py)
- Test config-only year change (2027 sanity test)
- Commit all changes in logical commits
- Update README.md with "Forecasting 2027+" section
- Create documentation/YEAR_AGNOSTIC.md

---

## üìä Test Status

**Current Test Results:**
- 23 passed
- 1 failed (expected - old spike log format)
- 3 skipped

**New Tests Added:**
- `test_events_ingest_preserves_future_year_columns.py` (2 tests) ‚úÖ
- `test_spike_flag_nan_safe_casting()` (1 test) ‚úÖ

**Tests to Add:**
- `test_year_template_paths.py` (PHASE 4)
- Generic naming wrapper tests (PHASE 5)

---

## üéØ Next Steps

1. **Complete PHASE 4** (Config-driven year templates)
   - Update run_daily.py to use format_year_path()
   - Make ingestion functions accept explicit paths
   - Add unit tests

2. **PHASE 5** (Generic naming)
   - Rename functions, keep backward-compatible wrappers

3. **PHASE 6** (Code cleanup)
   - Remove debug blocks, tighten exceptions

4. **PHASE 7** (Final validation)
   - Full test suite, parity check, documentation

---

## üîç Numeric Parity Tracking

**Baseline (V5.4):**
- Annual total (p50): $1,066,144.67

**After Each Phase:**
- PHASE 0: N/A (no code changes)
- PHASE 1: TBD (will test after PHASE 4 complete)
- PHASE 2: TBD
- PHASE 3: N/A (only .gitignore)
- PHASE 4: TBD (in progress)
- PHASE 5: TBD
- PHASE 6: TBD
- PHASE 7: FINAL VALIDATION

**Note:** Numeric parity will be validated after PHASE 4 is complete and before proceeding to PHASE 5.

---

## üìù Git Status

**Branch:** v5.4.2-10plusplus  
**Commits:** 3 (PHASE 1-3)  
**Uncommitted Changes:** config.yaml, runtime.py (PHASE 4 in progress)

**Commit History:**
```
4843aa7 PHASE 3: Repo hygiene - enhanced .gitignore
fc51c0e PHASE 2: Spike uplift NaN-safe flag casting
a9cca28 PHASE 1: Year-generic recurring mapping ingest + tests
```

---

## ‚è±Ô∏è Estimated Time Remaining

- PHASE 4 completion: 1-2 hours
- PHASE 5: 1 hour
- PHASE 6: 30 minutes
- PHASE 7: 1 hour
- **Total:** 3.5-4.5 hours

---

## üìå Key Decisions Made

1. **Year Template Format:** Using `{year}` placeholder in config paths
2. **Backward Compatibility:** Keeping all old 2026-specific paths and function names as aliases
3. **Test Strategy:** Adding tests incrementally per phase, not waiting until end
4. **Commit Strategy:** One commit per phase for clear history

---

## ‚úÖ Definition of Done (Checklist)

- [x] PHASE 0: Branch + baseline safety
- [x] PHASE 1: Year-generic recurring mapping
- [x] PHASE 2: NaN-safe spike flag casting
- [x] PHASE 3: Repo hygiene
- [ ] PHASE 4: Config-driven year templates (40% done)
- [ ] PHASE 5: Generic naming + aliases
- [ ] PHASE 6: Remove debug + tighten exceptions
- [ ] PHASE 7: Final validation + docs
- [ ] Numeric parity validated ($0.00 difference)
- [ ] All tests passing
- [ ] Ruff checks passing
- [ ] Documentation updated

---

**Last Updated:** January 4, 2026  
**Status:** 50% Complete (3.5/7 phases done)
