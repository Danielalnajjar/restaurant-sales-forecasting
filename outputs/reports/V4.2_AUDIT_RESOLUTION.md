# V4.2 Audit Resolution Report

**Date**: 2026-01-02  
**Version**: V4.2  
**Status**: ⚠️ PARTIAL SUCCESS - 2/3 fixes working, OOF overlay over-correcting

---

## Executive Summary

Implemented all 3 fixes recommended by ChatGPT 5.2 Pro audit. Results show **partial success**:

| Metric | Target | V4.1 (Before) | V4.2 (After) | Status |
|--------|--------|---------------|--------------|--------|
| **Annual Total** | +10% ($1,066K) | +19% ($1,155K) | **+12.9% ($1,094K)** | ✅ Improved |
| **Q1 Daily Avg** | +10% ($2,367) | +27.5% ($2,745) | **+21.5% ($2,615)** | ⚠️ Better but still high |
| **Black Friday** | ±15% ($5,700-$7,700) | -34% ($4,417) | **+35.5% ($9,086)** | ❌ Over-corrected |

**Conclusion**: Fixes #1 and #3 working well. Fix #2 (OOF overlay) over-correcting spike days.

---

## Fixes Implemented

### Fix #1: Cap `days_since_start` ✅ WORKING

**Problem**: Unbounded linear time feature extrapolated 2025 growth into 2026, causing additive uplift that looked like huge % increase in low-base Q1.

**Solution**: 
```python
# Before
df['days_since_start'] = (df[ds_col] - ref_date).dt.days

# After
days_since = (df[ds_col] - ref_date).dt.days.clip(lower=0)
df['days_since_open_capped_365'] = days_since.clip(upper=365)
df['days_since_open_log1p'] = np.log1p(days_since.clip(upper=365))
```

**Impact**:
- Q1 forecast dropped from +27.5% to +21.5% ✅
- Annual total dropped from +19% to +12.9% ✅
- Still 11.5% above target for Q1 ⚠️

**Assessment**: Working but not sufficient. Other features (events, seasonality) still contributing to Q1 inflation.

---

### Fix #2: Fix & Re-Enable OOF Spike Overlay ⚠️ OVER-CORRECTING

**Problem**: OOF overlay was disabled due to schema mismatch, causing systematic spike-day under-prediction.

**Solution**:
1. Rewrote `oof_spike_overlay.py` with schema normalization
2. Added non-compounding multipliers (max, not product)
3. Added shrinkage (0.65) and caps (0.85-1.80)
4. Re-enabled in `export.py`

**Multipliers Computed**:
- `is_black_friday`: **1.800x** (capped from 2.652 raw)
- `is_memorial_day`: **1.660x**
- `is_memorial_day_weekend`: **1.442x**
- `is_labor_day_weekend`: **1.089x**

**Impact**:
- Black Friday: $4,417 → **$9,086** (+106% increase!)
- Memorial Day: Similar over-correction expected
- Applied to 7 days total

**Assessment**: Over-correcting. The 1.8x multiplier is too aggressive. Raw model was probably ~$5,000, multiplier pushed to $9,086.

**Root Cause**: The multiplier was computed from OOF predictions that were themselves under-predicting (due to limited training data). Applying 1.8x to a better model creates over-correction.

**Recommended Fix**: Lower cap from 1.80 to 1.30-1.40, or disable overlay and rely on spike indicators alone.

---

### Fix #3: Fix Event Aggregates Distribution Shift ✅ WORKING

**Problem**: 2026 used recurring + exact events for aggregates, training only used recurring. This created distribution shift (2026 had higher event counts than model ever saw).

**Solution**:
```python
# Before
df_daily = pd.concat([df_daily_exact, df_daily_recurring], ignore_index=True)

# After
df_daily = df_daily_recurring.copy()  # Use ONLY recurring for aggregates
logger.info(f"Using {len(df_daily_recurring)} recurring event-days for aggregates (excluding {len(df_daily_exact)} exact events to match training)")
```

**Impact**:
- Reduced artificial Q1 event count inflation
- Contributed to Q1 dropping from +27.5% to +21.5%

**Assessment**: Working as intended. Train/inference consistency restored.

---

## Results Analysis

### Overall Performance

| Metric | 2025 Actual | V4.2 P50 | V4.2 P80 | vs Actual | vs Target (+10%) |
|--------|-------------|----------|----------|-----------|------------------|
| **Annual Total** | $969,222 | $1,094,291 | $1,165,724 | +12.9% | +2.6% |
| **Daily Average** | $2,677 | $3,016 | $3,212 | +12.7% | +2.5% |

### Quarterly Breakdown

| Quarter | 2025 Actual | V4.2 P50 | Difference | Assessment |
|---------|-------------|----------|------------|------------|
| **Q1** | $2,152/day | $2,615/day | **+21.5%** | ⚠️ Too high (target: +10%) |
| **Q2** | $2,770/day | $3,196/day | +15.4% | ⚠️ Slightly high |
| **Q3** | $3,125/day | $3,205/day | +2.6% | ✅ Excellent |
| **Q4** | $2,645/day | $2,965/day | +12.1% | ✅ Good |

### Monthly Breakdown

| Month | 2025 Actual | V4.2 P50 | Difference | Assessment |
|-------|-------------|----------|------------|------------|
| **Jan** | $2,075 | $2,819 | **+35.9%** | ❌ Way too high |
| **Feb** | $2,033 | $2,436 | +19.8% | ⚠️ Too high |
| **Mar** | $2,337 | $2,573 | +10.1% | ✅ Perfect |
| **Apr** | $2,660 | $2,844 | +6.9% | ✅ Good |
| **May** | $2,729 | $3,386 | +24.1% | ⚠️ Too high |
| **Jun** | $2,921 | $3,357 | +14.9% | ⚠️ Slightly high |
| **Jul** | $3,709 | $3,417 | -7.9% | ✅ Good (conservative) |
| **Aug** | $3,210 | $3,230 | +0.6% | ✅ Excellent |
| **Sep** | $2,455 | $2,969 | +20.9% | ⚠️ Too high |
| **Oct** | $2,417 | $2,897 | +19.9% | ⚠️ Too high |
| **Nov** | $2,518 | $2,968 | +17.9% | ⚠️ Too high |
| **Dec** | $3,003 | $3,030 | +0.9% | ✅ Perfect |

### Peak Days

| Day | 2025 Actual | V4.2 P50 | V4.2 P80 | Difference | Assessment |
|-----|-------------|----------|----------|------------|------------|
| **Black Friday** | $6,705 | $9,086 | $9,496 | **+35.5%** | ❌ Way too high |
| **Memorial Day** | $4,732 | ~$6,500* | ~$7,000* | ~+37%* | ❌ Likely too high |

*Estimated based on 1.66x multiplier

---

## Success Criteria Evaluation

| Criterion | Target | V4.2 Result | Status |
|-----------|--------|-------------|--------|
| **Q1 within ±5% of +10%** | +5% to +15% | **+21.5%** | ❌ Failed |
| **Black Friday within ±15%** | $5,700-$7,700 | **$9,086** | ❌ Failed |
| **Annual total within ±5% of +10%** | +5% to +15% | **+12.9%** | ✅ Passed |
| **Peak days count (6-12)** | 6-12 days > $5K | 8 days | ✅ Passed |

**Overall**: 2/4 criteria met. Not production-ready without further adjustments.

---

## Root Cause Analysis

### Why Q1 is Still +21.5% (Target: +10%)?

1. ✅ **Fixed**: `days_since_start` capped (reduced from +27.5% to +21.5%)
2. ✅ **Fixed**: Event aggregates consistent (contributed to reduction)
3. ⚠️ **Remaining**: Other features still contributing:
   - Seasonal patterns learned from limited data (only 1 Q1 in training)
   - Day-of-week effects (Q1 2026 may have different day distribution)
   - Residual trend in other features

**Hypothesis**: The model learned "sales are growing" from the within-year 2025 pattern (Q1 → Q3 increase), and even with capped `days_since_start`, other features (month, seasonality) carry that signal.

**Potential Fix**: Apply a **post-hoc Q1 adjustment** (scale down by 10-15%) or add explicit "year" feature to distinguish 2024/2025/2026.

### Why Black Friday is +35.5% (Target: ±15%)?

1. ✅ **OOF overlay applied**: 1.8x multiplier
2. ❌ **Over-correction**: Raw model was probably ~$5,000, multiplier pushed to $9,086
3. **Root Cause**: Multiplier computed from under-predicting OOF baseline, but V4.2 model (with holiday distance fix) is better, so 1.8x is too much

**Potential Fix**: Lower OOF cap from 1.80 to 1.30-1.40, or disable overlay entirely.

---

## Recommendations

### Immediate (Production Deployment)

**Option A: Use V4.2 with Manual Adjustments** ✅ RECOMMENDED
1. **Q1**: Scale down Jan-Feb by 15% manually
   - Jan: $2,819 → $2,396 (+15.5%)
   - Feb: $2,436 → $2,071 (+1.9%)
2. **Black Friday**: Use V4.1 P80 ($4,792) or manually set to $6,000
3. **Rest of year**: Use V4.2 as-is (good accuracy)

**Option B: Use V4.1 with Manual Adjustments**
1. **Q1**: Scale down by 20%
2. **Peak days**: Use P80 instead of P50
3. **Rest of year**: Use as-is

**Option C: Disable OOF Overlay (V4.3)**
1. Set `ENABLE_OOF_SPIKE_OVERLAY = False` in `export.py`
2. Rely on spike indicators + holiday distance features
3. Regenerate forecast
4. Expected: Black Friday ~$5,000-$6,000 (better than $9,086)

### Short-Term (Next 30 Days)

1. **Monitor Q1 2026 actuals** (Jan-Mar)
2. **Retrain in April 2026** with Q1 data included
3. **Validate** if Q1 over-prediction was real or model error

### Medium-Term (Next 3-6 Months)

1. **Lower OOF cap** from 1.80 to 1.30-1.40
2. **Add year feature** to distinguish 2024/2025/2026 explicitly
3. **Implement trend decomposition** (separate trend from seasonality)
4. **Collect more data** (target: 2+ years for robust seasonality learning)

### Long-Term (Next 6-12 Months)

1. **Implement hierarchical model** (day-of-week → month → year)
2. **Add external regressors** (weather, tourism data, local events)
3. **Implement Bayesian approach** for better uncertainty quantification
4. **Add unit tests** for spike flags, holiday distance, OOF overlay

---

## Files Changed

| File | Changes | Lines |
|------|---------|-------|
| `src/forecasting/features/feature_builders.py` | Cap days_since_start at 365 | 34-41 |
| `src/forecasting/features/oof_spike_overlay.py` | Complete rewrite with schema normalization | 1-230 |
| `src/forecasting/pipeline/export.py` | Re-enable OOF overlay, fix column names | 232-314 |
| `src/forecasting/features/events_daily.py` | Use only recurring events for aggregates | 212-232 |

---

## Conclusion

**V4.2 is a significant improvement over V4.1**:
- Annual total: +19% → +12.9% (closer to +10% target)
- Q1: +27.5% → +21.5% (better but still high)
- July/Aug/Dec: Excellent accuracy

**But not production-ready without adjustments**:
- Q1 needs manual scaling (-15%)
- Black Friday over-corrected (+35.5% instead of ±15%)

**Recommended next step**: Deploy V4.2 with manual Q1 adjustments (Option A) while working on V4.3 with disabled OOF overlay.

---

## Appendix: OOF Overlay Multipliers

| Spike Flag | Raw Ratio | Shrunk (0.65) | Capped (0.85-1.80) | Days Applied |
|------------|-----------|---------------|-------------------|--------------|
| `is_black_friday` | 2.652 | 2.074 | **1.800** | 1 |
| `is_memorial_day` | 2.016 | 1.660 | **1.660** | 1 |
| `is_memorial_day_weekend` | 1.680 | 1.442 | **1.442** | 3 |
| `is_labor_day_weekend` | 1.137 | 1.089 | **1.089** | 3 |
| `is_year_end_week` | N/A | N/A | **Skipped** | 0 (no training data) |

**Total days with overlay**: 7 (out of 365)
