# V5.4.5 Changelog ‚Äî "10++ Quality Hardening"

**Release Date:** 2026-01-05  
**Branch:** v5.4.5-10pp-quality  
**Base:** V5.4.4  
**Status:** ‚úÖ PRODUCTION-READY  

---

## Overview

V5.4.5 implements 7 quality improvements identified by ChatGPT 5.2 Pro's audit of V5.4.4, achieving **true 10++ production quality** while maintaining **perfect numeric parity** ($0.00 difference).

---

## What Changed

### 1. ‚úÖ Replaced traceback.print_exc() with logger.exception()

**Issue:** 4 locations used `traceback.print_exc()` which bypasses logging controls

**Files Changed:**
- `src/forecasting/pipeline/export.py` (growth calibration exception)
- `src/forecasting/pipeline/run_daily.py` (pipeline failure exception)
- `src/forecasting/models/chronos2.py` (fit and predict exceptions)

**Impact:** All exceptions now properly logged through logging framework

**Commit:** `9fb2f41` - Replace traceback.print_exc with logger.exception

---

### 2. ‚úÖ Made stable pointer artifacts true filesystem copies

**Issue:** `run_log.json` stable pointer re-wrote JSON instead of copying file

**Files Changed:**
- `src/forecasting/pipeline/export.py`

**Fix:** Changed from `json.dump()` to `shutil.copy2()` for byte-for-byte identical copy

**Impact:** Stable pointer is now guaranteed identical to slugged version

**Commit:** `8cd5daa` - Make stable pointer artifacts true filesystem copies

---

### 3. ‚úÖ Made monthly calibration scales year-agnostic

**Issue:** Column names hardcoded to `baseline_2025_month_total` and `target_2026_month_total`

**Files Changed:**
- `src/forecasting/pipeline/export.py`

**Fixes:**
- Added `_select_baseline_year()` helper function (consistent with growth calibration logic)
- Renamed columns to `baseline_year_month_total` and `target_year_month_total`
- Added `baseline_year` and `forecast_year` metadata columns
- Reordered columns to standard schema

**Impact:** Monthly calibration scales CSV now works for any forecast year (2026, 2027, 2028+)

**Commit:** `dce404b` - Make monthly calibration scales year-agnostic (no 2025/2026 hardcodes)

---

### 4. ‚úÖ Removed hardcoded events history path

**Issue:** `events_daily.py` used hardcoded path `"data/processed/features/events_daily_history.parquet"`

**Files Changed:**
- `src/forecasting/features/events_daily.py`

**Fix:** Changed to use `config["paths"]["processed_events_history"]`

**Impact:** Events history path now config-driven (better portability)

**Commits:**
- `858ce03` - Use config path for events_daily_history parquet (no hardcoded path)
- `d7897ac` - Fix config key name for events history path

---

### 5. ‚úÖ Eliminated mutable default quantile lists

**Issue:** Model constructors used mutable default `quantiles=[0.5, 0.8, 0.9]` (Python anti-pattern)

**Files Changed:**
- `src/forecasting/models/chronos2.py`
- `src/forecasting/models/gbm_short.py`
- `src/forecasting/models/gbm_long.py`

**Fix:** Changed to `quantiles: list | None = None` with `self.quantiles = quantiles or [0.5, 0.8, 0.9]`

**Impact:** Prevents potential cross-instance mutation bugs

**Commit:** `1ad4e74` - Eliminate mutable default quantile lists in model constructors

---

### 6. ‚úÖ Tightened ruff lint config (removed E722 ignore)

**Issue:** `pyproject.toml` ignored E722 (bare except) despite no violations existing

**Files Changed:**
- `pyproject.toml`
- `src/forecasting/pipeline/export.py` (whitespace cleanup)

**Fix:** Removed E722 from ignore list, ran `ruff format` to fix whitespace

**Impact:** Future bare except blocks will be caught by linter

**Commit:** `dc61cc4` - Tighten ruff lint: enforce no bare except (remove E722 ignore)

---

### 7. ‚úÖ Test hygiene: removed sys.path hacks and __main__ runners

**Issue:** 2 test files had `sys.path.insert()` and `if __name__ == "__main__"` blocks

**Files Changed:**
- `tests/test_config_resolution.py`
- `tests/test_forecast_window_param.py`

**Fixes:**
- Removed `sys.path.insert(0, ...)` (tests run via pytest with PYTHONPATH)
- Removed `if __name__ == "__main__": pytest.main([__file__, "-v"])` blocks
- Removed unused imports (Path, pytest)

**Impact:** Cleaner test files, proper pytest usage

**Commits:**
- `c162a29` - Test hygiene: remove sys.path hacks and __main__ runners from tests
- `ee805b4` - Fix formatting and remove unused imports

---

### 8. ‚ùå Missing README.md (FALSE POSITIVE - SKIPPED)

**Claim:** README.md missing despite `pyproject.toml` declaration

**Verification:** README.md EXISTS (2760 bytes, created Dec 31)

**Action:** SKIPPED (no fix needed)

---

## Quality Metrics

### Before V5.4.5 (V5.4.4):
- ‚úÖ 44 tests passing
- ‚úÖ 0 ruff errors
- ‚úÖ All files formatted
- ‚ö†Ô∏è 7 quality gaps (logging, pointers, year-agnostic, paths, mutable defaults, ruff config, test hygiene)

### After V5.4.5:
- ‚úÖ **44 tests passing** (no regressions)
- ‚úÖ **0 ruff errors**
- ‚úÖ **All 45 files formatted**
- ‚úÖ **All 7 quality gaps fixed**
- ‚úÖ **Perfect numeric parity** ($0.00 difference)

---

## Numeric Parity Verification

| Metric | Baseline (V5.4.4) | Current (V5.4.5) | Difference |
|--------|-------------------|------------------|------------|
| **P50 Total** | $1,066,144.67 | $1,066,144.67 | **$0.00** |
| **P80 Total** | $1,126,960.19 | $1,126,960.19 | **$0.00** |
| **P90 Total** | $1,162,270.29 | $1,162,270.29 | **$0.00** |
| **Max Daily Diff (P50)** | - | - | **$0.00** |
| **Max Daily Diff (P80)** | - | - | **$0.00** |
| **Max Daily Diff (P90)** | - | - | **$0.00** |

**Result:** ‚úÖ **PERFECT PARITY** - All changes were quality-only (no business logic impact)

---

## Git Commits

```
953dc3d - Fix logging statement to handle string path
d7897ac - Fix config key name for events history path
ee805b4 - Fix formatting and remove unused imports
c162a29 - Test hygiene: remove sys.path hacks and __main__ runners from tests
dc61cc4 - Tighten ruff lint: enforce no bare except (remove E722 ignore)
1ad4e74 - Eliminate mutable default quantile lists in model constructors
858ce03 - Use config path for events_daily_history parquet (no hardcoded path)
dce404b - Make monthly calibration scales year-agnostic (no 2025/2026 hardcodes)
8cd5daa - Make stable pointer artifacts true filesystem copies
9fb2f41 - Replace traceback.print_exc with logger.exception
```

**Total Commits:** 10 clean commits

---

## Breaking Changes

### ‚ö†Ô∏è Monthly Calibration Scales CSV Schema Change

**Old Schema (V5.4.4):**
```csv
month,month_scale,forecast_nonspike_total_before,forecast_nonspike_total_after,baseline_2025_month_total,target_2026_month_total,forecast_spike_total,achieved_month_total_after
```

**New Schema (V5.4.5):**
```csv
month,baseline_year,forecast_year,baseline_year_month_total,target_year_month_total,forecast_nonspike_total_before,forecast_nonspike_total_after,forecast_spike_total,achieved_month_total_after,month_scale
```

**Impact:**
- Column names changed from `baseline_2025_month_total` ‚Üí `baseline_year_month_total`
- Column names changed from `target_2026_month_total` ‚Üí `target_year_month_total`
- Added `baseline_year` and `forecast_year` columns
- Column order changed (month_scale moved to end)

**Migration:** Update any downstream scripts that parse `monthly_calibration_scales.csv`

---

## Deployment Notes

### Ready for Production
- ‚úÖ All quality gates passing
- ‚úÖ Perfect numeric parity verified
- ‚úÖ All tests passing
- ‚úÖ No regressions

### Post-Deployment
- Monitor logs to verify `logger.exception()` works as expected
- Verify monthly calibration scales CSV has correct year columns
- Test 2027+ forecasts to confirm year-agnostic behavior

---

## Credits

**Implementation:** Manus AI  
**Audit & Plan:** ChatGPT 5.2 Pro  
**Verification:** Independent verification of all 8 claimed issues  
**Result:** 7 real issues fixed, 1 false positive identified  

---

**V5.4.5 Status:** ‚úÖ PRODUCTION-READY ‚Äî True 10++ Quality Achieved üéâ
